<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coder Chat</title>
    <style>
        body { padding: 0; margin: 0; font-family: var(--vscode-font-family); }
        .chat-container { display: flex; flex-direction: column; height: 100vh; }
        .messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 4px; max-width: 80%; }
        .user-message { background-color: var(--vscode-editor-inactiveSelectionBackground); align-self: flex-end; margin-left: auto; white-space: pre-wrap; }
        .ai-message { background-color: var(--vscode-editor-selectionBackground); align-self: flex-start; }
        .input-area { padding: 10px; display: flex; }
        #message-input { flex: 1; padding: 8px; border: 1px solid var(--vscode-input-border); background-color: var(--vscode-input-background); color: var(--vscode-input-foreground); }
        button { margin-left: 5px; background-color: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; padding: 8px 12px; cursor: pointer; }
        .typing-indicator { padding: 8px 12px; color: var(--vscode-descriptionForeground); font-style: italic; }
        
        /* Enhanced Markdown Styling */
        .ai-message code {
            font-family: var(--vscode-editor-font-family);
            background-color: var(--vscode-editor-background);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .ai-message pre {
            background-color: var(--vscode-editor-background);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid var(--vscode-panel-border);
        }
        
        .ai-message pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
        }
        
        .ai-message h1, .ai-message h2, .ai-message h3, 
        .ai-message h4, .ai-message h5, .ai-message h6 {
            margin-top: 16px;
            margin-bottom: 8px;
            color: var(--vscode-foreground);
            font-weight: 600;
        }
        
        .ai-message h1 { font-size: 1.5em; border-bottom: 1px solid var(--vscode-panel-border); padding-bottom: 4px; }
        .ai-message h2 { font-size: 1.3em; border-bottom: 1px solid var(--vscode-panel-border); padding-bottom: 4px; }
        .ai-message h3 { font-size: 1.2em; }
        .ai-message h4 { font-size: 1.1em; }
        
        .ai-message ul, .ai-message ol {
            padding-left: 24px;
            margin: 8px 0;
        }
        
        .ai-message li {
            margin-bottom: 4px;
        }
        
        .ai-message p {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .ai-message blockquote {
            border-left: 3px solid var(--vscode-activityBarBadge-background);
            margin: 8px 0;
            padding-left: 12px;
            color: var(--vscode-descriptionForeground);
        }
        
        .ai-message table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
        }
        
        .ai-message th, .ai-message td {
            border: 1px solid var(--vscode-panel-border);
            padding: 6px 8px;
            text-align: left;
        }
        
        .ai-message th {
            background-color: var(--vscode-editor-lineHighlightBackground);
            font-weight: 600;
        }
        
        .ai-message a {
            color: var(--vscode-textLink-foreground);
            text-decoration: none;
        }
        
        .ai-message a:hover {
            text-decoration: underline;
            color: var(--vscode-textLink-activeForeground);
        }
        
        .ai-message hr {
            border: none;
            border-top: 1px solid var(--vscode-panel-border);
            margin: 16px 0;
        }
        
        .ai-message img {
            max-width: 100%;
            margin: 8px 0;
        }
        
        /* Language-specific syntax highlighting classes */
        .ai-message .language-js, .ai-message .language-javascript,
        .ai-message .language-ts, .ai-message .language-typescript,
        .ai-message .language-html, .ai-message .language-css,
        .ai-message .language-json, .ai-message .language-python,
        .ai-message .language-java, .ai-message .language-csharp,
        .ai-message .language-cpp, .ai-message .language-c {
            color: var(--vscode-editor-foreground);
        }
        
        /* Updated context section styling */
        .context-section {
            margin-bottom: 16px;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .context-header {
            background-color: var(--vscode-editor-background);
            padding: 8px 12px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }
        
        .context-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }
        
        .context-items {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px 0;
        }
        
        .empty-context {
            color: var(--vscode-descriptionForeground);
            font-style: italic;
            padding: 8px 12px;
        }
        
        .context-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 3px;
            margin: 0 4px;
        }
        
        .context-item:hover {
            background-color: var(--vscode-list-hoverBackground);
        }
        
        .context-item-icon {
            margin-right: 8px;
            color: var(--vscode-symbolIcon-fileForeground);
        }
        
        .context-item-icon.folder {
            color: var(--vscode-symbolIcon-folderForeground);
        }
        
        .context-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .context-item-remove {
            cursor: pointer;
            opacity: 0.7;
            padding: 4px;
            border-radius: 3px;
        }
        
        .context-item-remove:hover {
            opacity: 1;
            background-color: var(--vscode-list-hoverBackground);
        }
        
        .context-actions {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-panel-border);
        }
        
        .context-button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .context-button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        
        .context-button.secondary {
            background-color: transparent;
            color: var(--vscode-button-secondaryForeground);
            border: 1px solid var(--vscode-button-secondaryBackground);
        }
        
        .context-button.secondary:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Context selection section -->
        <div class="context-section">
            <div class="context-header">
                <h3>Context Files & Folders</h3>
            </div>
            <div class="context-items" id="contextItems">
                <!-- Context items will be added here dynamically -->
                <div class="empty-context">No context items selected</div>
            </div>
            <div class="context-actions">
                <button class="context-button" id="addContextBtn">
                    <span class="codicon codicon-add"></span>
                    Add Files/Folders
                </button>
                <button class="context-button secondary" id="clearContextBtn">
                    <span class="codicon codicon-clear-all"></span>
                    Clear All
                </button>
            </div>
        </div>
        
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Ask AI Coder...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const vscode = acquireVsCodeApi();
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const contextItemsContainer = document.getElementById('contextItems');
        const addContextBtn = document.getElementById('addContextBtn');
        const clearContextBtn = document.getElementById('clearContextBtn');
        
        // Send message function
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                vscode.postMessage({ type: 'sendMessage', message });
                messageInput.value = '';
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Markdown formatting using marked.js
        function formatText(text) {
            // Configure marked options
            marked.setOptions({
                breaks: true,        // Add line breaks on single newlines
                gfm: true,           // Use GitHub Flavored Markdown
                headerIds: false,    // Don't add IDs to headers
                langPrefix: 'language-', // CSS language prefix for code blocks
            });
            
            // Process the text with marked
            return marked.parse(text);
        }
        
        // Handle context item updates from extension
        // Update context items display
        function updateContextItems(items) {
            const contextItemsContainer = document.getElementById('contextItems');
            
            if (!items || items.length === 0) {
                contextItemsContainer.innerHTML = '<div class="empty-context">No context items selected</div>';
                return;
            }
            
            let html = '';
            for (const item of items) {
                const iconClass = item.isDirectory ? 'codicon-folder' : 'codicon-file';
                const iconType = item.isDirectory ? 'folder' : 'file';
                
                html += `
                    <div class="context-item" data-path="${item.path}">
                        <span class="context-item-icon ${iconType} codicon ${iconClass}"></span>
                        <span class="context-item-name" title="${item.path}">${item.name}</span>
                        <span class="context-item-remove codicon codicon-close" title="Remove from context"></span>
                    </div>
                `;
            }
            
            contextItemsContainer.innerHTML = html;
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.context-item-remove').forEach(button => {
                button.addEventListener('click', (e) => {
                    const item = e.target.closest('.context-item');
                    const path = item.dataset.path;
                    vscode.postMessage({
                        type: 'contextAction',
                        action: 'remove',
                        path: path
                    });
                    e.stopPropagation();
                });
            });
        }
        
        // Add context button click handler
        addContextBtn.addEventListener('click', () => {
            vscode.postMessage({
                type: 'contextAction',
                action: 'add'
            });
        });
        
        // Clear context button click handler
        clearContextBtn.addEventListener('click', () => {
            vscode.postMessage({
                type: 'contextAction',
                action: 'clear'
            });
        });
        
        // Handle messages from extension
        window.addEventListener('message', (event) => {
            const message = event.data;
            console.log('Received message:', message.type);
            
            switch (message.type) {
                case 'updateContext':
                    updateContextItems(message.contextItems);
                    break;
                    
                case 'addMessage':
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message');
                    messageDiv.classList.add(message.sender + '-message');
                    
                    if (message.sender === 'user') {
                        // For user messages, just use text content
                        messageDiv.textContent = message.message;
                    } else {
                        // For AI messages, use markdown formatting
                        messageDiv.innerHTML = formatText(message.message);
                        messageDiv.setAttribute('data-raw-content', message.message);
                    }
                    
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    break;
                    
                case 'startAIMessage':
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.id = 'current-ai-message';
                    aiMessageDiv.classList.add('message');
                    aiMessageDiv.classList.add('ai-message');
                    messagesContainer.appendChild(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    break;
                    
                case 'appendToAIMessage':
                    const currentAiMessage = document.getElementById('current-ai-message');
                    if (currentAiMessage) {
                        // Store the current raw content (before formatting)
                        let rawContent = currentAiMessage.getAttribute('data-raw-content') || '';
                        
                        // Add the new content to the raw content
                        rawContent += message.message;
                        
                        // Store the updated raw content
                        currentAiMessage.setAttribute('data-raw-content', rawContent);
                        
                        // Apply markdown formatting to the entire content
                        currentAiMessage.innerHTML = formatText(rawContent);
                        
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    break;
                    
                case 'completeAIMessage':
                    const completedMessage = document.getElementById('current-ai-message');
                    if (completedMessage) {
                        completedMessage.removeAttribute('id');
                    }
                    break;
                    
                case 'showTyping':
                    const typingDiv = document.createElement('div');
                    typingDiv.id = 'typing-indicator';
                    typingDiv.classList.add('typing-indicator');
                    typingDiv.textContent = 'AI is thinking...';
                    messagesContainer.appendChild(typingDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    break;
                    
                case 'hideTyping':
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    break;
            }
        });
    </script>
</body>
</html>